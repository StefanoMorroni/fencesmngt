<?xml version="1.0"?>

<f:view xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui">
	
	<h:head>
		<script src="http://maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script>
	</h:head>
	<h:body>
	
	<h:form id="addFenceForm">
		<p:dialog id="addFence" widgetVar="addFence" header="Aggiungi Fence" modal="true" height="520" width="950" resizable="false">
			<p:messages id="messages" autoUpdate="true" />
			<p:panel id="addFencePanel" style="background-color:#F1F1F1;">
				<p:panelGrid style="width:100%;height:400px;">
					<p:row>
						<p:column style="width:25%;"><p:outputLabel for="name" value="Nome Fence:" style="font-family:sans-serif;font-size:11px;"/></p:column>
						<p:column><p:outputLabel value="Seleziona il punto centrale del FENCE dalla mappa:" style="font-family:sans-serif;font-size:11px;"/></p:column>
					</p:row>
					<p:row>
						<p:column><p:inputText id="name" value="#{fencesManagementBean.fenceEntry.name}" required="true" /></p:column>
						<p:column rowspan="6">
							<ui:include src="/views/fences-mngt/map.xhtml" />
						</p:column>
					</p:row>
					<p:row>
						<p:column><p:outputLabel for="description" value="Descrizione Fence:" style="font-family:sans-serif;font-size:11px;"/></p:column>
					</p:row>
					<p:row>
						<p:column><p:inputText id="description" value="#{fencesManagementBean.fenceEntry.description}" required="true" /></p:column>
					</p:row>
					<p:row>
						<p:column><p:outputLabel for="radius" value="Lunghezza Raggio Fence:" style="font-family:sans-serif;font-size:11px;"/></p:column>
					</p:row>
					<p:row>
						<p:column><p:inputText id="radius" styleClass="radius" value="#{fencesManagementBean.fenceEntry.radius}" onblur="setOver();" required="true" /></p:column>
					</p:row>
					<p:row>
						<p:column><p:outputLabel for="enabled" value="Abilitato:" style="font-family:sans-serif;font-size:11px;"/></p:column>
					</p:row>
					<p:row>
						<p:column>
							<p:selectOneRadio id="enabled" value="#{fencesManagementBean.fenceEntry.enabled}" required="true">
			            		<f:selectItem itemLabel="SI" itemValue="true" />
			            		<f:selectItem itemLabel="NO" itemValue="false" />
		            		</p:selectOneRadio>
						</p:column>
						<p:column>
							<p:column><p:outputLabel value="Coordinate Centro:" style="font-family:sans-serif;font-size:11px;padding-right:5px;"/></p:column>
							<p:column>
								<h:inputText id="centerLat" styleClass="centerLat" value="#{fencesManagementBean.fenceEntry.centerLat}" />
								<p:spacer width="10px" />
								<h:inputText id="centerLon" styleClass="centerLon" value="#{fencesManagementBean.fenceEntry.centerLon}" />
							</p:column>
						</p:column>
					</p:row>
					<p:row>
						<p:column colspan="2">
							<p:commandButton id="saveNewFence" value="Salva" action="#{fencesManagementBean.saveNewFence}" update=":fenceAlarmTabs:fencesGridForm" oncomplete="onSaveFence(xhr, status, args)"/>
						</p:column>
					</p:row>
				</p:panelGrid>
				<p:remoteCommand name="set_overlay" id="set_overlay" update="map" actionListener="#{mapManagementBean.setOverlay}" immediate="true"/>
			</p:panel>
			
		</p:dialog>
	
	</h:form>
	
	<script type="text/javascript" charset="UTF-8">
		var currentMarker;
		
	    function handlePointClick(event) {
	    	cancel();
	    	if(currentMarker == null) {
		    	$('.centerLat').val(event.latLng.lat());
			  	$('.centerLon').val(event.latLng.lng());
			    currentMarker = new google.maps.Marker({
			    	position:new google.maps.LatLng(event.latLng.lat(), event.latLng.lng())
			    });
			    
			    PF('map').addOverlay(currentMarker);   
	    	}
	    	if ($('.radius').val() != 0) setOver();							// AGGIUNTO PER OVERLAY CIRCLES
	    }
	    
	    function cancel() {
	    	cancelCircle();													// AGGIUNTO PER OVERLAY CIRCLES
	    	var gmap = PF('map').getMap();
	    	for (var i in gmap.markers) {
	    		if (gmap.markers[i] != null) gmap.markers[i].setMap(null);
	    	}
	    	if (currentMarker != null) currentMarker.setMap(null);
	        currentMarker = null;
	        return false;
	    }
	    
	    function cancelCircle() {											// AGGIUNTO PER OVERLAY CIRCLES
	    	var gmap = PF('map').getMap();									// AGGIUNTO PER OVERLAY CIRCLES
	    	for (var i in gmap.circles) {									// AGGIUNTO PER OVERLAY CIRCLES
	    		if (gmap.circles[i] != null) gmap.circles[i].setMap(null);	// AGGIUNTO PER OVERLAY CIRCLES
	    	}
	    }
	    
	    function setOver() {
	    	if ($('.radius').val() != 0) {
	    		if ($('.centerLat').val() != 0) {
	    			set_overlay([{ name:'radius', value:$('.radius').val()}, {name:'lat', value:$('.centerLat').val()}, {name:'lng', value:$('.centerLon').val()}]);
	    		}
	    	}
	    }
	</script>
	
	</h:body>
	
</f:view>